<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section" id="all-slots">
    </div>
    <div id="table"></div>
    <script>
      // number of slots to show
      var totalSlots = 2;
      
      // cq scripts
      var engagementScript, trafficScript;
      $(document).ready(function() {
        engagementScript = $.trim($('#engagement').html());
        trafficScript = $.trim($('#traffic').html());
        
        // loop through slots
        for (var i = 1; i <= totalSlots; i++) {
          addSlot(i);
        }

      });
      // cq params
      var engagementParams = {};
      var trafficParams = {};
      
      // add slot info to report
      function addSlot(num) {
        slot = $('<div id="slot' + num + '" class="slot">').appendTo('#all-slots');
        $('<div class="slot-num">' + num + '</div>').appendTo(slot);
        getCurrentStory(num);
        getEngagementScore(num);
        getTrafficBreakdown(num);
      }
      
      function getCurrentStory(slot) {
        
      }
      
      function getEngagementScore(slot) {
        engagementParams[slot] = {
          1: {
            "slot": slot,
            "from_date": moment().subtract(30, 'days'),
            "to_date": moment(),
          },
          2: {
            "slot": slot,
            "from_date": moment(),
            "to_date": moment(),
          }
        }
        var promises = [];
        var predicted = new Promise(function(resolve, reject) {
          MP.api.custom_query(engagementScript, engagementParams[slot][1]).done(function(results) {
            resolve(results);
          });
        });
        var now = new Promise(function(resolve, reject) {
          MP.api.custom_query(engagementScript, engagementParams[slot][2]).done(function(results) {
            resolve(results);
          });
        });
        promises.push(predicted, now);
        Promise.all(promises).then(function(data) {
          displayEngagement(slot, data);
        });
      }
      
      function displayEngagement(slot, results) {
        console.log(slot);
        console.log(results);
        var graphObject = {
          'Predicted': data[0],
          'Actual': data[1]
        }
        console.log(graphObject);
      }
      
      function getTrafficBreakdown(slot) {
        
      }
      
    </script>
    <script type="text/cq" id="engagement">
      function main() {
          var object = {};
          var currentHour = new Date().getHours();
          var events = {
              'Video Started': 5,
              'Story View': 3,
              'Page View': 2,
              'Social Share': 1,
          }
        // Take all events in the given date range.
        return Events({
          from_date: params.from_date,
          to_date: params.to_date,
        })
        .filter(function(event) {
            return Object.keys(events).indexOf(event.name) > -1 && event.properties.Slot == params.slot
        })
        .groupBy(
              [
                function(event) { return new Date(event.time).getHours(); }
              ],
              function(accumulators, items) {
                  var sum = 0;
                  _.each(items, function(event) {
                      sum += events[event.name];
                  });
                  _.each(accumulators, function(accum) {
                      sum += accum;
                  })
                  return sum;
              }
          )
          .filter(function(item) { return currentHour-4 <= item.key && item.key <= currentHour })
          .map(function(item) { 
              var object = {}
              var hour = item.key[0] % 12 || 12;
              object[hour + ':00'] = item.value;
              return object;
          })
          .reduce(mixpanel.reducer.object_merge())
      }
    </script>
  </body>
</html>
