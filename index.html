<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section" id="all-slots">
    </div>
    <div id="table"></div>
    <script>
      // number of slots to show
      var totalSlots = 5;
      // number of days to analyze predictions
      var predictedDays = 30;
      
      // cq scripts
      var engagementScript, trafficScript;
      $(document).ready(function() {
        engagementScript = $.trim($('#engagement').html());
        trafficScript = $.trim($('#traffic').html());
        
        // loop through slots
        for (var i = 1; i <= totalSlots; i++) {
          addSlot(i);
        }

      });
      // cq params
      var engagementParams = {};
      var trafficParams = {};
      
      // add slot info to report
      function addSlot(num) {
        slot = $('<div id="slot' + num + '" class="slot">').appendTo('#all-slots');
        $('<div class="slot-num">' + num + '</div>').appendTo(slot);
        getCurrentStory(num);
        getEngagementScore(num);
        getTrafficBreakdown(num);
      }
      
      function getCurrentStory(slot) {
        
      }
      
      function getEngagementScore(slot) {
        engagementParams[slot] = {
          1: {
            'slot': slot,
            'from_date': date_to_string(moment().subtract(predictedDays, 'days')),
            'to_date': date_to_string(moment()),
          },
          2: {
            'slot': slot,
            'from_date': date_to_string(moment().subtract(1, 'days')),
            'to_date': date_to_string(moment()),
          }
        }
        var promises = [];
        var predicted = new Promise(function(resolve, reject) {
          MP.api.custom_query(engagementScript, engagementParams[slot][1]).done(function(results) {
            resolve(results);
          });
        });
        var now = new Promise(function(resolve, reject) {
          MP.api.custom_query(engagementScript, engagementParams[slot][2]).done(function(results) {
            resolve(results);
          });
        });
        promises.push(predicted, now);
        Promise.all(promises).then(function(data) {
          displayEngagement(slot, data);
        });
      }
      
      function displayEngagement(slot, data) {
        var slotDiv = $('#slot' + slot);

        // add engagement data to slot in report
        var currentEngagement = data[1][4];
        $('<div class="engage-label">Engagement Score:</div><div class="engage-score">' + currentEngagement + '</div>').appendTo(slotDiv);
        
        var vsPredicted = data[1][4] - data[0][4]/predictedDays;
        $('<div class="vs-score" style="color: ' + colorFormat(vsPredicted) + ';">' + vsPredicted + '</div><div class="vs-label">vs. Predicted</div>').appendTo(slotDiv);
        
        // format graph data
        var graphObject = {
          'Predicted': {},
          'Actual': {},
        }
        _.each(data[0], function(object) {
          var time = Object.keys(object)[0];
          graphObject.Predicted[time] = object[time]/predictedDays;
        });
        _.each(data[1], function(object) {
          var time = Object.keys(object)[0];
          graphObject.Actual[time] = object[time];
        });
        
        // add graph to slot in report
        $('<div class="graph engage-graph"></div>').appendTo(slotDiv).MPChart({
          chartType: 'line',
          data: graphObject
        });
      }
      
      function getTrafficBreakdown(slot) {
        
      }
      
      function date_to_string(d) {
        return d.toISOString().split('T')[0];
      }
      
      function colorFormat(n) {
        return n > 0 ? 'green' : n < 0 ? 'red' : 'black';
      }
      
    </script>
    <script type="text/cq" id="engagement">
      function main() {
          var object = {};
          var currentHour = new Date().getHours();
          var events = {
              'Video Started': 5,
              'Story View': 3,
              'Page View': 2,
              'Social Share': 1,
          }
        // Take all events in the given date range.
        return Events({
          from_date: params.from_date,
          to_date: params.to_date,
        })
        .filter(function(event) {
            return Object.keys(events).indexOf(event.name) > -1 && event.properties.Slot == params.slot
        })
        .groupBy(
              [
                function(event) { return new Date(event.time).getHours(); }
              ],
              function(accumulators, items) {
                  var sum = 0;
                  _.each(items, function(event) {
                      sum += events[event.name];
                  });
                  _.each(accumulators, function(accum) {
                      sum += accum;
                  })
                  return sum;
              }
          )
          .filter(function(item) { return currentHour-4 <= item.key && item.key <= currentHour })
          .map(function(item) { 
              var object = {}
              var hour = item.key[0] % 12 || 12;
              object[hour + ':00'] = item.value;
              return object;
          });
      }
    </script>
  </body>
</html>
