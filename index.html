<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <style>
      body {
        font-size: 13px;
        color: #868ea3;
      }
      .slot {
        margin: 20px 0;
      }
      .slot-num {
        font-size: 24px;
      }
      .graph {
        margin: 15px;
      }
      .engage-label {
        font-size: 15px;
      }
      .graph-container {
        width: 300px;
      }
      .chart-header {
        width: 100%;
      }
      .mp-graph {
        height: 200px;
        width: 300px;
      }
      .mp-graph .graph {
        height: 200px;
        width: 300px;
        margin: 0;
      }
      .chart-header {
        background-color: rgb(223, 226, 236);
      }
      .chart-title-shadow {
        background-color: transparent;
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100%;
        height: 1px;
        z-index: 3;
        box-shadow: 0 1px 2px 0 rgba(0,0,0,0.2);
      }
      .chart-title-container {
        text-align: center;
        padding: 8px 0;
        z-index: 4;
      }
      .chart-title {
        color: #747d94;
        font-size: 1em;
        font-weight: bold;
      }
    </style>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section" id="all-slots"></div>
    <script>
    //////////////////////////// things to fix
    // how to get only today?
    
      // number of slots to show
      var totalSlots = 5;
      // number of days to analyze predictions 
      // currently last 4 weeks
      var predictedDays = 28;
      
      // cq scripts
      var engagementScript, vsallScript, trafficScript, storyScript, timeScript;
      $(document).ready(function() {
        engagementScript = $.trim($('#engagement').html());
        vsallScript = $.trim($('#vsall').html());
        trafficScript = $.trim($('#referred-traffic').html());
        storyScript = $.trim($('#current-story').html());
        timeScript = $.trim($('#story-time').html());
        
        // loop through slots
        for (var i = 1; i <= totalSlots; i++) {
          addSlot(i);
        }
      });
      // cq params
      var engagementParams = {};
      var vsallParams = {};
      var trafficParams = {};
      var storyParams = {};
      var timeParams = {};
      
      // add slot info to report
      function addSlot(num) {
        slot = $('<div id="slot' + num + '" class="slot">').appendTo('#all-slots');
        $('<div class="slot-num">' + num + '</div>').appendTo(slot);
        getCurrentStory(num);
        getEngagementScore(num);
        getTrafficBreakdown(num);
      }
      
      function getCurrentStory(slot) {
        storyParams[slot] = {
          'slot': slot,
          'from_date': date_to_string(moment().subtract(1, 'days')),
          'to_date': date_to_string(moment()),
        }
        MP.api.custom_query(storyScript, storyParams[slot]).done(function(results) {
          timeParams[slot] = {
            'story': results[0].current_story,
            'from_date': date_to_string(moment().subtract(1, 'days')),
            'to_date': date_to_string(moment()),
          }
          MP.api.custom_query(timeScript, timeParams[slot]).done(function(timeResults) {
            displayStory(slot, results, timeResults);
          });
        });
      }
      
      function displayStory(slot, results, timeResults) {
        var slotDiv = $('#slot' + slot);
        $('<div class="story-info">' + 
        '<div class="story-stat">Current Story: ' + results[0].current_story + '</div>' + 
        '<div class="story-stat">Time in Slot: ' + results[0].time_in_slot + '</div>' + 
        '<div class="story-stat">Time since Publish: ' + timeResults[0] + '</div>' + 
        '<div class="story-stat">Engagement: ' + results[0].stats['Story View'] + ' views, ' + 
        results[0].stats['Video Started'] + ' video starts, ' + 
        results[0].stats['Social Share'] + ' shares' + '</div>' + 
        '</div>').appendTo(slotDiv);
      }
      
      function getEngagementScore(slot) {
        engagementParams[slot] = {
          1: {
            'slot': slot,
            'from_date': date_to_string(moment().subtract(predictedDays, 'days')),
            'to_date': date_to_string(moment()),
          },
          2: {
            'slot': slot,
            'from_date': date_to_string(moment().subtract(1, 'days')),
            'to_date': date_to_string(moment()),
          }
        }
        vsallParams[slot] = {
          'slot': slot,
          'slot_max': totalSlots,
          'from_date': date_to_string(moment().subtract(1, 'days')),
          'to_date': date_to_string(moment()),
        }
        var promises = [];
        var predicted = new Promise(function(resolve, reject) {
          MP.api.custom_query(engagementScript, engagementParams[slot][1]).done(function(results) {
            resolve(results);
          });
        });
        var now = new Promise(function(resolve, reject) {
          MP.api.custom_query(engagementScript, engagementParams[slot][2]).done(function(results) {
            resolve(results);
          });
        });
        var vsall = new Promise(function(resolve, reject) {
          MP.api.custom_query(vsallScript, vsallParams[slot]).done(function(results) {
            resolve(results);
          });
        });
        promises.push(predicted, now, vsall);
        Promise.all(promises).then(function(data) {
          displayEngagement(slot, data);
        });
      }
      
      function addChart(slot, div, number, title, data) {
        var slotDiv = $('#slot' + slot);
        var highcharts = {
            chart: {
                marginBottom: 30
            },
            xAxis: {
                labels: {
                    style: {
                      'font-weight': 'bold'
                    }
                }
            },
            yAxis: {
                gridLineColor: '#E6E8EB',
                gridLineDashStyle: 'Dash',
                gridLineWidth: 1,
                labels: {
                    style: {
                      'font-weight': 'bold'
                    }
                }
            }
        }
        
        var $graphDiv = $('<div class="graph-container"></div>').appendTo(slotDiv);
        $('<div class="chart-header"><div class="chart-title-shadow"></div><div class="chart-title-container"><div class="chart-title"><span style="color: ' + colorFormat(number) + '">' + number + '</span> ' + title + '</div></div></div>').appendTo($graphDiv);
        $('<div class="mp-graph ' + div + '"></div>').appendTo($graphDiv).MPChart({
          chartType: 'line',
          highchartsOptions: highcharts,
          data: data
        });
        $('.' + div + ' .mixpanel-platform-chart_header').hide();
      }
      
      function displayEngagement(slot, data) {
        var slotDiv = $('#slot' + slot);

        // add engagement data to slot in report
        var length = data[1].length-1;
        var currentHour = Object.keys(data[0][length])[0];
        var currentEngagement = data[1][length][currentHour];
        $('<div class="engage-label">Engagement Score:</div><div class="engage-score">' + currentEngagement + '</div>').appendTo(slotDiv);
        
        var vsPredicted = data[1][length][currentHour] - data[0][length][currentHour]/predictedDays;
        $('<div class="vs-score" style="color: ' + colorFormat(vsPredicted) + ';">' + vsPredicted + '</div><div class="vs-label">vs. Predicted</div>').appendTo(slotDiv);
        
        // format graph data
        var graphObject = {
          'Predicted': {},
          'Actual': {},
        }
        _.each(data[0], function(object) {
          var time = Object.keys(object)[0];
          graphObject.Predicted[time] = object[time]/predictedDays;
        });
        _.each(data[1], function(object) {
          var time = Object.keys(object)[0];
          graphObject.Actual[time] = object[time];
        });

        // add graph to slot in report
        addChart(slot, 'engage-graph', vsPredicted, 'VS. PREDICTED', graphObject);
        // $('<div class="mp-graph engage-graph"></div>').appendTo(slotDiv).MPChart({
        //   chartType: 'line',
        //   data: graphObject,
        //   highchartsOptions: {
        //     legend: {
        //       enabled: false
        //     }
        //   }
        // });
        
        // add engagement vs all other slots
        var slotText = 'Slot ' + slot;
        var vsallGraphObject = {};
        _.each(data[2], function(object) {
          $.extend(true, vsallGraphObject, object);
        });
        
        var vsallData = vsallGraphObject['Slot ' + slot][currentHour] - vsallGraphObject['All Others'][currentHour];
        $('<div class="vs-score" style="color: ' + colorFormat(vsallData) + ';">' + vsallData + '</div><div class="vs-label">vs. other slots in feed</div>').appendTo(slotDiv);
        
        // add engagement vs all other slots graph
        addChart(slot, 'vsall-graph', vsallData, 'VS. ALL OTHER SLOTS', vsallGraphObject);

        // $('<div class="mp-graph vsall-graph"></div>').appendTo(slotDiv).MPChart({
        //   chartType: 'line',
        //   data: vsallGraphObject,
        //   highchartsOptions: {
        //     legend: {
        //       enabled: false
        //     }
        //   }
        // });
      }
      
      function getTrafficBreakdown(slot) {
        trafficParams[slot] = {
          'slot': slot,
          'from_date': date_to_string(moment().subtract(1, 'days')),
          'to_date': date_to_string(moment()),
        }
        MP.api.custom_query(trafficScript, trafficParams[slot]).done(function(results) {
          displayTraffic(slot, results);
        });
      }
      
      function displayTraffic(slot, data) {
        console.log(data)
        var slotDiv = $('#slot' + slot);
        var trafficObject = {};
        _.each(data, function(object) {
          $.extend(true, trafficObject, object);
        });
        console.log(trafficObject)
        $('<div class="mp-graph traffic-graph"></div>').appendTo(slotDiv).MPChart({
          chartType: 'bar',
          stacked: true,
          data: trafficObject,
          highchartsOptions: {
            legend: {
              enabled: false
            }
          }
        });
      }
      
      function date_to_string(d) {
        return d.toISOString().split('T')[0];
      }
      
      function colorFormat(n) {
        return n > 0 ? 'green' : n < 0 ? 'red' : 'black';
      }
      
    </script>
    <script type="text/cq" id="engagement">
        function convertTime(hour, change) {
            if (hour < change) {
                return 24 - change;
            } else {
                return hour - change;
            }
        }
        var timezone = 5;
        
        function main() {
            var object = {};
            var currentHour = convertTime(new Date().getHours(), timezone); // convert utc to est timezone
            var events = {
                'Video Started': 5,
                'Story View': 3,
                'Page View': 2,
                'Social Share': 1,
            }
            // Take all events in the given date range.
            return Events({
              from_date: params.from_date,
              to_date: params.to_date,
            })
            .filter(function(event) {
                return Object.keys(events).indexOf(event.name) > -1 && event.properties.Slot == params.slot;
            })
            .groupBy(
                [
                    function(event) { return new Date(event.time).getHours(); }
                ],
                function(accumulators, items) {
                    var sum = 0;
                    _.each(items, function(event) {
                        sum += events[event.name];
                    });
                    _.each(accumulators, function(accum) {
                        sum += accum;
                    });
                    return sum;
                }
            )
            .filter(function(item) { return currentHour-12 <= item.key && item.key <= currentHour; })
            .map(function(item) { 
                var object = {}
                var hour = item.key[0] % 12 || 12;
                object[hour + ':00'] = item.value;
                return object;
            });
        }
    </script>
    <script type="text/cq" id="vsall">
        function convertTime(hour, change) {
            if (hour < change) {
                return 24 - change;
            } else {
                return hour - change;
            }
        }
        var timezone = 5;
        
        function main() {
            var object = {};
            var currentHour = convertTime(new Date().getHours(), timezone); // convert utc to est timezone
            var events = {
                'Video Started': 5,
                'Story View': 3,
                'Page View': 2,
                'Social Share': 1,
            }
            // Take all events in the given date range.
            return Events({
              from_date: params.from_date,
              to_date: params.to_date,
            })
            .filter(function(event) {
                return Object.keys(events).indexOf(event.name) > -1 && event.properties.Slot <= params.slot_max;
            })
            .groupBy(
                [
                    function(event) { return event.properties.Slot == params.slot; },
                    function(event) { return new Date(event.time).getHours(); }
                ],
                function(accumulators, items) {
                    var sum = 0;
                    _.each(items, function(event) {
                        sum += events[event.name];
                    });
                    _.each(accumulators, function(accum) {
                        sum += accum;
                    });
                    return sum;
                }
            )
            .filter(function(item) { return currentHour-12 <= item.key[1] && item.key[1] <= currentHour; })
            .map(function(item) { 
                var object = {};
                var type = item.key[0] ? 'Slot ' + params.slot : 'All Others';
                object[type] = {};
                var hour = item.key[1] % 12 || 12;
                object[type][hour + ':00'] = item.key[0] ? item.value : item.value/(params.slot_max-1);
                return object;
            });
        }
    </script>
    <script type="text/cq" id="basic-traffic">
        var sources = {
            'Social': ['facebook', 'twitter', 'linkedin', 'pinterest',],
            'Search': ['google', 'bing', 'yahoo',],
            'Direct': ['direct'],
            'Internal': ['espn']
        }
        function readSources(domain) {
            var types = Object.keys(sources);
            for (var i = 0, j = types.length; i < j; i++) {
                for (var k = 0, l = sources[types[i]].length; k < l; k++) {
                    if (domain.indexOf(sources[types[i]][k]) > -1) {
                        return types[i];
                    }
                }
            }
            return 'Other';
        }
        function getTrafficSource(event) {
            var url = event.properties.$initial_referrer; // use referring domain
            var split = url.split('/'); // delete
            if (split.length >= 3) { // delete
                url = split[2] // delete
            } else { // del
                return 'Direct'; // del
            } // del
            if (!url) { return 'Direct'; }
            var domainList = url.split('.');
            if (domainList.length <= 1) { return readSources(url); }
            var domain = domainList.slice(0, domainList.length-1).join('.');
            return readSources(domain);
        }
        
        function main() {
            // Take all events in the given date range.
            return Events({
                from_date: params.from_date,
                to_date: params.to_date,
            })
            .filter(function(event) { return event.name == 'Story View' && event.properties.Slot == params.slot; }) // use page view event
            .groupBy(
                [getTrafficSource],
                mixpanel.reducer.count()
            )
        }
    </script>
    <script type="text/cq" id="referred-traffic">
        function convertTime(hour, change) {
            if (hour < change) {
                return 24 - change;
            } else {
                return hour - change;
            }
        }
        var timezone = 5;

        function getTrafficSource(event) {
            var url = event.properties.$initial_referrer;
            var split = url.split('/');
            if (split.length >= 3) {
                url = split[2]
            } else {
                return 'Other';
            }
            if (!url) { return 'Other'; }
            var espn = 'baidu'; // change to espn
            if (url.indexOf(espn) > -1)  {
                return 'Other';
            }
            return 'Referred';
        }
        function getStoryPlacement(event) {
            var placement = event.properties["Event Placement"];
            if (placement == 'Main Feed') { return 'Feed'; }
            return 'All Other';
        }
        
        function main() {
            var currentHour = convertTime(new Date().getHours(), timezone); // convert utc to est timezone
            // Take all events in the given date range.
            return Events({
                from_date: params.from_date,
                to_date: params.to_date,
            })
            .filter(function(event) { return event.name == 'Story View' && event.properties.Slot == params.slot; }) // use page view
            .groupBy(
                [
                    function(event) { return new Date(event.time).getHours(); },
                    getStoryPlacement,
                    getTrafficSource
                ],
                mixpanel.reducer.count()
            )
            .filter(function(item) { return currentHour-12 <= item.key[0] && item.key[0] <= currentHour; })
            .map(function(item) { 
                var object = {};
                var type = item.key[1];
                object[type] = {};
                var hour = item.key[0] % 12 || 12;
                object[type][hour + ':00'] = item.value;
                return object;
            });
        }
    </script>
    <script type="text/cq" id="current-story">
        function msToTime(duration) {
            var milliseconds = parseInt((duration%1000)/100),
                seconds = parseInt((duration/1000)%60),
                minutes = parseInt((duration/(1000*60))%60),
                hours = parseInt((duration/(1000*60*60))%24);
        
            hours = (hours < 10) ? "0" + hours : hours;
            minutes = (minutes < 10) ? "0" + minutes : minutes;
            seconds = (seconds < 10) ? "0" + seconds : seconds;
        
            return hours + ":" + minutes + ":" + seconds; // switch to just minutes
        }
        function main() {
            var events = ['Video Started', 'Story View', 'Page View', 'Social Share',]
            // Take all events in the given date range.
            return Events({
              from_date: params.from_date,
              to_date: params.to_date,
            })
            .filter(function(event) {
                return events.indexOf(event.name) > -1 && parseInt(event.properties.Slot) == params.slot;
            })
            .reduce(function(previous_outputs, events) {
                var ret = {
                    stories: {
                        last_story_end: 0, 
                        current_story_start: 0, 
                        current_story_end: 0, 
                        current_story: ''
                    },
                    stats: {
                        'Story View': 0, // will be page view
                        'Video Started': 0,
                        'Social Share': 0
                    }
                };
        
                for (var i = 0; i < previous_outputs.length; i++){
                    ret.stats['Story View'] += previous_outputs[i].stats['Story View'];
                    ret.stats['Video Started'] += previous_outputs[i].stats['Video Started'];
                    ret.stats['Social Share'] += previous_outputs[i].stats['Social Share'];
                    
                    if (ret.stories.current_story == previous_outputs[i].stories.current_story) {
                        if (ret.stories.current_story_start > previous_outputs[i].stories.current_story_start && ret.stories.last_story_end < previous_outputs[i].stories.current_story_start) {
                            ret.stories.current_story_start = previous_outputs[i].stories.current_story_start
                        }
                        if (ret.stories.current_story_end < previous_outputs[i].stories.current_story_end) {
                            ret.stories.current_story_end = previous_outputs[i].stories.current_story_end
                        }
                        if (ret.stories.last_story_end < previous_outputs[i].stories.last_story_end) {
                            ret.stories.last_story_end = previous_outputs[i].stories.last_story_end
                        }
                    } else {
                        if (ret.stories.current_story_end < previous_outputs[i].stories.current_story_end) {
                            ret.stories.current_story = previous_outputs[i].stories.current_story;
                            if (ret.stories.current_story_end > previous_outputs[i].stories.last_story_end) {
                                ret.stories.last_story_end = ret.stories.current_story_end;
                            }
                            ret.stories.current_story_end = previous_outputs[i].stories.current_story_end;
                            if (ret.stories.current_story_start < ret.stories.last_story_end) {
                                ret.stories.current_story_start = ret.stories.last_story_end;
                            }
                        } else if (ret.stories.last_story_end < previous_outputs[i].stories.current_story_end) {
                            ret.stories.last_story_end = previous_outputs[i].stories.current_story_end;
                            if (ret.stories.current_story_start < previous_outputs[i].stories.current_story_end) {
                                ret.stories.current_story_start = previous_outputs[i].stories.current_story_end;
                            }
                        }
                    }
                }
                for (var k = 0; k < events.length; k++) {
                    var event = events[k];
                    if (
                        event.name == 'Story View' && 
                        event.properties["Story Headline"] == ret.stories.current_story && 
                        event.time > ret.stories.current_story_end
                    ) {
                        ret.stats['Story View'] ++;
        
                        ret.stories.current_story_end = event.time;
                    } else if (event.name == 'Story View') {
                        ret.stats['Story View'] ++;
                        
                        ret.stories.last_story_end = ret.stories.current_story_end;
                        ret.stories.current_story_start = event.time;
                        ret.stories.current_story_end = event.time;
                        ret.stories.current_story = event.properties["Story Headline"];
                    } else {
                        ret.stats[event.name] ++;
                    }
                }
                return ret;
            })
            .map(function(item) {
                var timeDiff = item.stories.current_story_end - item.stories.current_story_start;
                var result = {
                    current_story: item.stories.current_story,
                    time_in_slot: msToTime(timeDiff),
                    stats: item.stats,
                }
                return result;
            })
        }
    </script>
    <script type="text/cq" id="story-time">
        function msToTime(duration) {
            var milliseconds = parseInt((duration%1000)/100)
                , seconds = parseInt((duration/1000)%60)
                , minutes = parseInt((duration/(1000*60))%60)
                , hours = parseInt((duration/(1000*60*60))%24);
        
            hours = (hours < 10) ? "0" + hours : hours;
            minutes = (minutes < 10) ? "0" + minutes : minutes;
            seconds = (seconds < 10) ? "0" + seconds : seconds;
        
            return hours + ":" + minutes + ":" + seconds; // switch to just minutes
        }
        function main() {
            // Take all events in the given date range.
            return Events({
              from_date: params.from_date,
              to_date: params.to_date,
            })
            .filter(function(event) {
                return event.name == 'Story View' && event.properties['Story Headline'] == params.story;
            })
            .reduce(function(previous_outputs, events) {
                var result = 100000000000000000;
                _.each(previous_outputs, function(output) {
                    if (output < result) {
                        result = output;
                    }
                });
                _.each(events, function(e) {
                    if (e.time < result) {
                        result = e.time;
                    }
                });
                return result;
            })
            .map(function(result) {
                var now = Date.now();
                return msToTime(now - result);
            });
        }
    </script>
  </body>
</html>
